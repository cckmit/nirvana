---
title: ä»€ä¹ˆæ˜¯PNPMï¼Ÿ
date: 2021-11-12 16:13:30
category: javascript
---

## ä»€ä¹ˆæ˜¯PNPMï¼Ÿ

> Fast, disk space efficient package manager

æœ¬è´¨ä¸Šä»–æ˜¯ä¸€ä¸ªåŒ…ç®¡ç†å·¥å…·ï¼Œå’Œnpm/yarnæ²¡æœ‰åŒºåˆ«ï¼Œä¸»è¦ä¼˜åŠ¿åœ¨äº

- åŒ…å®‰è£…é€Ÿåº¦æå¿«
- ç£ç›˜ç©ºé—´åˆ©ç”¨æ•ˆç‡é«˜

ä½¿ç”¨æ–¹æ³•ï¼š

```
npm i pnpm -g
```





## ä¼˜åŠ¿

### ä¸€ã€é€Ÿåº¦å¿«

![](https://upload-images.jianshu.io/upload_images/10024246-83a5f0645167c5e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### äºŒã€é«˜æ•ˆåˆ©ç”¨ç£ç›˜ç©ºé—´

##### ç¡¬é“¾æ¥(Hard Link)

    ç¡¬è¿æ¥æŒ‡é€šè¿‡ç´¢å¼•èŠ‚ç‚¹æ¥è¿›è¡Œè¿æ¥ã€‚åœ¨Linuxçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¿å­˜åœ¨ç£ç›˜åˆ†åŒºä¸­çš„æ–‡ä»¶ä¸ç®¡æ˜¯ä»€ä¹ˆç±»å‹éƒ½ç»™å®ƒåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œç§°ä¸ºç´¢å¼•èŠ‚ç‚¹å·(Inode Index)ã€‚åœ¨Linuxä¸­ï¼Œå¤šä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ç´¢å¼•èŠ‚ç‚¹æ˜¯å­˜åœ¨çš„ã€‚ä¸€èˆ¬è¿™ç§è¿æ¥å°±æ˜¯ç¡¬è¿æ¥ã€‚ç¡¬è¿æ¥çš„ä½œç”¨æ˜¯å…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªæœ‰æ•ˆè·¯å¾„åï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥å»ºç«‹ç¡¬è¿æ¥åˆ°é‡è¦æ–‡ä»¶ï¼Œä»¥é˜²æ­¢â€œè¯¯åˆ â€çš„åŠŸèƒ½ã€‚å…¶åŸå› å¦‚ä¸Šæ‰€è¿°ï¼Œå› ä¸ºå¯¹åº”è¯¥ç›®å½•çš„ç´¢å¼•èŠ‚ç‚¹æœ‰ä¸€ä¸ªä»¥ä¸Šçš„è¿æ¥ã€‚åªåˆ é™¤ä¸€ä¸ªè¿æ¥å¹¶ä¸å½±å“ç´¢å¼•èŠ‚ç‚¹æœ¬èº«å’Œå…¶å®ƒçš„è¿æ¥ï¼Œåªæœ‰å½“æœ€åä¸€ä¸ªè¿æ¥è¢«åˆ é™¤åï¼Œæ–‡ä»¶çš„æ•°æ®å—åŠç›®å½•çš„è¿æ¥æ‰ä¼šè¢«é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶çœŸæ­£åˆ é™¤çš„æ¡ä»¶æ˜¯ä¸ä¹‹ç›¸å…³çš„æ‰€æœ‰ç¡¬è¿æ¥æ–‡ä»¶å‡è¢«åˆ é™¤ã€‚

##### è½¯è¿æ¥(Symbolic Link)

    å¦å¤–ä¸€ç§è¿æ¥ç§°ä¹‹ä¸ºç¬¦å·è¿æ¥ï¼Œä¹Ÿå«è½¯è¿æ¥ã€‚è½¯é“¾æ¥æ–‡ä»¶æœ‰ç±»ä¼¼äºWindowsçš„å¿«æ·æ–¹å¼ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ã€‚åœ¨ç¬¦å·è¿æ¥ä¸­ï¼Œæ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«çš„æœ‰å¦ä¸€æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ã€‚



pnpm å†…éƒ¨ä½¿ç”¨`åŸºäºå†…å®¹å¯»å€`çš„æ–‡ä»¶ç³»ç»Ÿæ¥å­˜å‚¨ç£ç›˜ä¸Šæ‰€æœ‰çš„æ–‡ä»¶ï¼š

- ä¸ä¼šé‡å¤å®‰è£…åŒä¸€ä¸ªåŒ…ã€‚ä½¿ç”¨` npm/yarn ` çš„æ—¶å€™ï¼Œå¦‚æœ100ä¸ªåŒ…ä¾èµ–` lodash ` ï¼Œé‚£ä¹ˆå°±å¯èƒ½å®‰è£…äº†100æ¬¡` lodash ` ï¼Œç£ç›˜ä¸­å°±æœ‰100ä¸ªåœ°æ–¹å†™å…¥äº†è¿™éƒ¨åˆ†ä»£ç ã€‚ä½†æ˜¯` pnpm `ä¼šåªåœ¨ä¸€ä¸ªåœ°æ–¹å†™å…¥è¿™éƒ¨åˆ†ä»£ç ï¼Œåé¢ä½¿ç”¨ä¼šç›´æ¥ä½¿ç”¨` hard link ` 
- å³ä½¿ä¸€ä¸ªåŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œpnpm ä¹Ÿä¼šæå¤§ç¨‹åº¦åœ°å¤ç”¨ä¹‹å‰ç‰ˆæœ¬çš„ä»£ç ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ lodash æœ‰ 100 ä¸ªæ–‡ä»¶ï¼Œæ›´æ–°ç‰ˆæœ¬ä¹‹åå¤šäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆç£ç›˜å½“ä¸­å¹¶ä¸ä¼šé‡æ–°å†™å…¥ 101 ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¿ç•™åŸæ¥çš„ 100 ä¸ªæ–‡ä»¶çš„ `hardlink`ï¼Œä»…ä»…å†™å…¥é‚£`ä¸€ä¸ªæ–°å¢çš„æ–‡ä»¶`ã€‚

### ä¸‰ã€æ”¯æŒmonorepo

monorepo çš„å®—æ—¨å°±æ˜¯ç”¨ä¸€ä¸ª git ä»“åº“æ¥ç®¡ç†å¤šä¸ªå­é¡¹ç›®ï¼Œæ‰€æœ‰çš„å­é¡¹ç›®éƒ½å­˜æ”¾åœ¨æ ¹ç›®å½•çš„`packages`ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆä¸€ä¸ªå­é¡¹ç›®å°±ä»£è¡¨ä¸€ä¸ª`package`ã€‚

 monorepo ç®¡ç†å·¥å…·` lerna` 

é¡¹ç›®å‚è€ƒï¼š` babel ` 

### å››ã€å®‰å…¨

ä¹‹å‰åœ¨ä½¿ç”¨ npm/yarn çš„æ—¶å€™ï¼Œç”±äº node_module çš„æ‰å¹³ç»“æ„ï¼Œå¦‚æœ A ä¾èµ– Bï¼Œ B ä¾èµ– Cï¼Œé‚£ä¹ˆ A å½“ä¸­æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ C çš„ï¼Œä½†é—®é¢˜æ˜¯ A å½“ä¸­å¹¶æ²¡æœ‰å£°æ˜ C è¿™ä¸ªä¾èµ–ã€‚å› æ­¤ä¼šå‡ºç°è¿™ç§éæ³•è®¿é—®çš„æƒ…å†µã€‚ ä½† pnpm è‡ªåˆ›äº†ä¸€å¥—ä¾èµ–ç®¡ç†æ–¹å¼ï¼Œå¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¿è¯äº†å®‰å…¨æ€§ã€‚



## ä¾èµ–ç®¡ç†

pnpm ä¼šåœ¨å…¨å±€çš„ store ç›®å½•é‡Œå­˜å‚¨é¡¹ç›® `node_modules` æ–‡ä»¶çš„ `hard links` ã€‚å› ä¸ºè¿™æ ·ä¸€ä¸ªæœºåˆ¶ï¼Œå¯¼è‡´æ¯æ¬¡å®‰è£…ä¾èµ–çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯ä¸ªç›¸åŒçš„ä¾èµ–ï¼Œæœ‰å¥½å¤šé¡¹ç›®éƒ½ç”¨åˆ°è¿™ä¸ªä¾èµ–ï¼Œé‚£ä¹ˆè¿™ä¸ªä¾èµ–å®é™…ä¸Šæœ€ä¼˜æƒ…å†µ(å³ç‰ˆæœ¬ç›¸åŒ)åªç”¨å®‰è£…ä¸€æ¬¡ã€‚

#### å›å½’ä¸€ä¸‹ node_modules ç»“æ„å†å²ï¼š

**ç¬¬ä¸€é˜¶æ®µï¼šnpm@3 ä¹‹å‰ç‰ˆæœ¬**

```text
node_modules
â””â”€ foo
   â”œâ”€ index.js
   â”œâ”€ package.json
   â””â”€ node_modules
      â””â”€ bar
         â”œâ”€ index.js
         â””â”€ package.json
```

- ä¾èµ–æ ‘å±‚çº§å¤ªæ·±ï¼Œä¼šå¯¼è‡´ Windows ä¸Šçš„ç›®å½•è·¯å¾„è¿‡é•¿é—®é¢˜
- ç›¸åŒåŒ…åœ¨ä¸åŒçš„ä¾èµ–é¡¹ä¸­éœ€è¦æ—¶ï¼Œä¼šå­˜åœ¨å¤šä¸ªç›¸åŒå‰¯æœ¬

**ç¬¬äºŒé˜¶æ®µï¼šnpm@3 ç‰ˆæœ¬ï¼Œæ‰å¹³åŒ–å¤„ç†**

æ‰€æœ‰çš„ä¾èµ–éƒ½è¢«æ‹å¹³åˆ°`node_modules`ç›®å½•ä¸‹ï¼Œä¸å†æœ‰å¾ˆæ·±å±‚æ¬¡çš„åµŒå¥—å…³ç³»ã€‚è¿™æ ·åœ¨å®‰è£…æ–°çš„åŒ…æ—¶ï¼Œæ ¹æ® node require æœºåˆ¶ï¼Œä¼šä¸åœå¾€ä¸Šçº§çš„`node_modules`å½“ä¸­å»æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ç›¸åŒç‰ˆæœ¬çš„åŒ…å°±ä¸ä¼šé‡æ–°å®‰è£…ï¼Œè§£å†³äº†å¤§é‡åŒ…é‡å¤å®‰è£…çš„é—®é¢˜ï¼Œè€Œä¸”ä¾èµ–å±‚çº§ä¹Ÿä¸ä¼šå¤ªæ·±ã€‚

```text
node_modules
â”œâ”€ foo
|  â”œâ”€ index.js
|  â””â”€ package.json
â””â”€ bar
   â”œâ”€ index.js
   â””â”€ package.json
```

ä½†è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜

- ä¾èµ–ç»“æ„çš„**ä¸ç¡®å®šæ€§**ã€‚
- æ‰å¹³åŒ–ç®—æ³•æœ¬èº«çš„**å¤æ‚æ€§**å¾ˆé«˜ï¼Œè€—æ—¶è¾ƒé•¿ã€‚
- é¡¹ç›®ä¸­ä»ç„¶å¯ä»¥**éæ³•è®¿é—®**æ²¡æœ‰å£°æ˜è¿‡ä¾èµ–çš„åŒ…



è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿä¾èµ–ç»“æ„çš„`ä¸ç¡®å®š`é—®é¢˜ï¼Œä¹Ÿæ˜¯ `lock æ–‡ä»¶`è¯ç”Ÿçš„åŸå› ï¼Œæ— è®ºæ˜¯`package-lock.json`(npm 5.xæ‰å‡ºç°)è¿˜æ˜¯`yarn.lock`ï¼Œéƒ½æ˜¯ä¸ºäº†ä¿è¯ install ä¹‹åéƒ½äº§ç”Ÿç¡®å®šçš„`node_modules`ç»“æ„ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œnpm/yarn æœ¬èº«è¿˜æ˜¯å­˜åœ¨`æ‰å¹³åŒ–ç®—æ³•å¤æ‚`å’Œ`package éæ³•è®¿é—®`çš„é—®é¢˜ï¼Œå½±å“æ€§èƒ½å’Œå®‰å…¨ã€‚



**ç¬¬ä¸‰é˜¶æ®µï¼špnpm**

ç”±äºæ‰å¹³åŒ–ç®—æ³•çš„æå…¶å¤æ‚ï¼Œä»¥åŠä¼šå­˜åœ¨å¤šé¡¹ç›®é—´ç›¸åŒä¾èµ–å‰¯æœ¬çš„æƒ…å†µã€‚pnpm åœ¨å°è¯•è§£å†³è¿™äº›é—®é¢˜æ—¶ï¼Œæ”¾å¼ƒäº†æ‰å¹³åŒ–å¤„ç† node_modules çš„æ–¹å¼ã€‚è€Œæ˜¯é‡‡ç”¨ **ç¡¬é“¾+è½¯é“¾** æ–¹å¼ã€‚

```text
node_modules
â”œâ”€ .pnpm
|  â”œâ”€ foo@1.0.0/node_modules/foo
|  |  â””â”€ index.js
|  â””â”€ bar@2.0.0/node_modules/bar
â”œâ”€ foo -> .pnpm/foo@1.0.0/node_modules/foo
â””â”€ bar -> .pnpm/bar@2.0.0/node_modules/bar
```

node_modules æ ¹ç›®å½•ä¸­çš„åŒ…åªæ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚`require('foo')` å°†æ‰§è¡Œ `node_modules/.pnpm/foo@1.0.0/node_modules/foo/indexjs` ä¸­çš„æ–‡ä»¶ï¼ˆè¿™é‡Œæ˜¯ç¡¬é“¾æ¥ï¼‰ï¼Œè€Œä¸æ˜¯ `node_modules/foo/index.js` ä¸­çš„æ–‡ä»¶ã€‚

**è¿™ç§å¸ƒå±€ç»“æ„çš„ä¸€å¤§å¥½å¤„æ˜¯åªæœ‰çœŸæ­£åœ¨ä¾èµ–é¡¹ä¸­ï¼ˆpackage.json dependencesï¼‰çš„åŒ…æ‰èƒ½è®¿é—®**

**ä¸¾ä¸ªğŸŒ°**

å®‰è£…ä¸€ä¸ª`express` ä¾èµ–ï¼Œä¼šåœ¨ node_modules ä¸­å½¢æˆè¿™æ ·ä¸¤ä¸ªç›®å½•ç»“æ„:

```text
node_modules/express/...
node_modules/.pnpm/express@4.17.1/node_modules/xxx
```

å…¶ä¸­ç¬¬ä¸€ä¸ªè·¯å¾„æ˜¯ nodejs æ­£å¸¸å¯»æ‰¾è·¯å¾„ä¼šå»æ‰¾çš„ä¸€ä¸ªç›®å½•ï¼Œå¦‚æœå»æŸ¥çœ‹è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹ï¼Œä¼šå‘ç°é‡Œé¢è¿ä¸ª `node_modules` æ–‡ä»¶éƒ½æ²¡æœ‰ï¼š

```text
â–¾ express
    â–¸ lib
      History.md
      index.js
      LICENSE
      package.json
      Readme.md
```

å®é™…ä¸Šè¿™ä¸ªæ–‡ä»¶åªæ˜¯ä¸ªè½¯è¿æ¥ï¼Œå®ƒä¼šå½¢æˆä¸€ä¸ªåˆ°ç¬¬äºŒä¸ªç›®å½•çš„ä¸€ä¸ªè½¯è¿æ¥(ç±»ä¼¼äºè½¯ä»¶çš„å¿«æ·æ–¹å¼)ï¼Œè¿™æ · node åœ¨æ‰¾è·¯å¾„çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šæ‰¾åˆ° .pnpm è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹ã€‚

å…¶ä¸­è¿™ä¸ª `.pnpm` æ˜¯ä¸ªè™šæ‹Ÿç£ç›˜ç›®å½•ï¼Œç„¶å express è¿™ä¸ªä¾èµ–çš„ä¸€äº›ä¾èµ–ä¼šè¢«å¹³é“ºåˆ° `.pnpm/express@4.17.1/node_modules/` è¿™ä¸ªç›®å½•ä¸‹é¢ï¼Œè¿™æ ·ä¿è¯äº†ä¾èµ–èƒ½å¤Ÿ require åˆ°ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šå½¢æˆå¾ˆæ·±çš„ä¾èµ–å±‚çº§ã€‚

åœ¨ä¿è¯äº† nodejs èƒ½æ‰¾åˆ°ä¾èµ–è·¯å¾„çš„åŸºç¡€ä¸Šï¼ŒåŒæ—¶ä¹Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šä¿è¯äº†ä¾èµ–èƒ½å¾ˆå¥½çš„è¢«æ”¾åœ¨ä¸€èµ·ã€‚



## ç›®å‰ä¸é€‚ç”¨çš„åœºæ™¯

å‰é¢æœ‰æåˆ°å…³äº pnpm çš„ä¸»è¦é—®é¢˜åœ¨äº symlink(è½¯é“¾æ¥)åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¼šå­˜åœ¨å…¼å®¹çš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒä½œè€…åœ¨ nodejs é‚£è¾¹å¼€çš„ä¸€ä¸ª discussionï¼š[https://github.com/nodejs/node/discussions/37509](https://link.zhihu.com/?target=https%3A//github.com/nodejs/node/discussions/37509)

åœ¨é‡Œé¢ä½œè€…æåˆ°äº†ç›®å‰ nodejs è½¯è¿æ¥ä¸èƒ½é€‚ç”¨çš„ä¸€äº›åœºæ™¯ï¼Œå¸Œæœ› nodejs èƒ½æä¾›ä¸€ç§ link æ–¹å¼è€Œä¸æ˜¯ä½¿ç”¨è½¯è¿æ¥ï¼ŒåŒæ—¶ä¹Ÿæåˆ°äº† pnpm ç›®å‰å› ä¸ºè½¯è¿æ¥è€Œä¸èƒ½ä½¿ç”¨çš„åœºæ™¯:

- Electron åº”ç”¨æ— æ³•ä½¿ç”¨ pnpm
- éƒ¨ç½²åœ¨ [lambda](https://link.zhihu.com/?target=https%3A//docs.aws.amazon.com/lambda/latest/dg/gettingstarted-package.html) ä¸Šçš„åº”ç”¨æ— æ³•ä½¿ç”¨ pnpm

ä¸€äº› nodejs åŸºç¡€åº“ä¸æ”¯æŒ symlink çš„æƒ…å†µå¯¼è‡´ä½¿ç”¨ pnpm æ— æ³•æ­£å¸¸å·¥ä½œï¼Œä¸è¿‡è¿™äº›åº“åœ¨è¿­ä»£æ›´æ–°ä¹‹åä¹Ÿä¼šæ”¯æŒè¿™ä¸€ç‰¹æ€§ã€‚



## æ€»ç»“

pnpm æ–¹å¼çš„å®ç°ç²¾é«“

1. é€šè¿‡è½¯é“¾çš„å½¢å¼ï¼Œä½¿å¾— require å¯ä»¥æ­£å¸¸å¼•ç”¨ï¼›åŒæ—¶å¯¹éçœŸæ­£ä¾èµ–çš„é¡¹ç›®åšéš”ç¦»ï¼ˆé¿å…å¼•ç”¨ä¾èµ–çš„æ··ä¹±ï¼‰
2. `.pnpm` çš„å­˜åœ¨é¿å…äº†å¾ªç¯å¼•ç”¨å’Œå±‚çº§è¿‡æ·±çš„é—®é¢˜ï¼ˆéƒ½åœ¨å…¶ç¬¬ä¸€å±‚ï¼‰
3. ç¡¬é“¾ä½¿å¾—ä¸åŒé¡¹ç›®ç›¸åŒä¾èµ–åªå­˜åœ¨ä¸€ä¸ªå‰¯æœ¬ï¼Œå‡å°‘ç£ç›˜ç©ºé—´



## æœªæ¥ä¼šåšçš„ä¸€äº›äº‹æƒ…

### è„±ç¦» nodejs

å…·ä½“å¯ä»¥å‚è€ƒ [https://github.com/pnpm/pnpm/discussions/3434](https://link.zhihu.com/?target=https%3A//github.com/pnpm/pnpm/discussions/3434)

- å®‰è£… pnpm çš„ï¼Œ å¯ä»¥åŸºæœ¬ä¸Šè„±ç¦»æ‰ nodejs è¿™ä¸ª runtime å»è¿›è¡Œå®‰è£…ä½¿ç”¨ã€‚
- å¯ä»¥é€šè¿‡ pnpm æ¥ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ nodejs æ¥å»åšä¾èµ–å®‰è£…ï¼Œç±»ä¼¼äº nvm æä¾›çš„åŠŸèƒ½ã€‚

ç›®å‰è¯¥ç‰¹æ€§å…¶å®å·²ç»åˆ°äº† beta ç‰ˆæœ¬ï¼Œå¯ä»¥å‚è€ƒ [https://www.npmjs.com/package/@pnpm/beta](https://link.zhihu.com/?target=https%3A//www.npmjs.com/package/%40pnpm/beta) è¿™ä¸ªåŒ…ã€‚ç®¡ç†ä¸åŒç‰ˆæœ¬çš„ nodejs åŠŸèƒ½å¯ä»¥å‚è€ƒ env è¿™ä¸ªå­å‘½ä»¤: [https://pnpm.io/cli/env](https://link.zhihu.com/?target=https%3A//pnpm.io/cli/env)

### ä½¿ç”¨ rust å†™ä¸€äº›æ¨¡å—

å…·ä½“å¯ä»¥çœ‹ [https://github.com/pnpm/pnpm/discussions/3419](https://link.zhihu.com/?target=https%3A//github.com/pnpm/pnpm/discussions/3419) è¿™ä¸ª discussion è®¨è®ºçš„å†…å®¹ï¼Œå¤§æ¦‚å°±æ˜¯ä½œè€…å¸Œæœ›ç»™ pnpm çš„ä¸€äº›å­å‘½ä»¤æä¾›ä¸€äº› rust çš„ cli wrapper æ¥åšæå‡æ€§èƒ½ä½¿ç”¨ã€‚



