---
title: æ–°çš„åŸç”ŸHookï¼ŸuseEventï¼šä¸€ä¸ªæ˜¾è‘—é™ä½Hookså¿ƒæ™ºè´Ÿæ‹…çš„åŸç”ŸHook
date: 2022-06-03 16:28:03
categories: å‰ç«¯
---
# å‰è¨€

useEvent[1]Â æ˜¯ä¸€ä¸ªåˆšåˆšææ¡ˆçš„åŸç”ŸHookï¼Œè¿˜å¤„äºRFCã€‚è®¨è®ºåœ°å€åœ¨è¿™é‡Œ\~[2]ä¸‹é¢æœ‰äº›ä»£ç å°±æ˜¯æ¥è‡ªå…¶ä¸­

> RFCï¼šRequest for Comments ææ¡ˆè¿˜åœ¨å¹¿æ³›çš„è®¨è®ºé˜¶æ®µ

# ä¸ºä»€ä¹ˆè¦è¿™æ ·ğŸ¤”

## æ²¡æœ‰ useEvent çš„æ—¶å€™ğŸ˜¶

æˆ‘ä»¬å…ˆçœ‹çœ‹ä¸ç”¨ useEvent çš„æƒ…å†µï¼š

```
function Chat() {
  const [text, setText] = useState('');

  // ğŸŸ¡ Always a different function
  const onClick = () => {
    sendMessage(text);
  };

  return <SendButton onClick={onClick} />;
}
```

å…¶ä¸­ç‚¹å‡»äº‹ä»¶çš„å›è°ƒå‡½æ•°Â `onClick`Â ä¸­éœ€è¦è¯»å–å½“å‰é”®å…¥çš„æ–‡æœ¬`text`ï¼Œè¿™é‡Œçš„`onClick`éšç€ç»„ä»¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡æ¬¡åœ°é‡æ–°åˆ›å»ºï¼Œæ¯æ¬¡éƒ½ä¼šæ˜¯ä¸ä¸€æ ·çš„å¼•ç”¨ï¼Œè¿™æ˜¾ç„¶å¸¦æ¥äº†æ€§èƒ½æŸè€—ï¼Œå¦‚æœä½ æƒ³å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·åšï¼š

```
function Chat() {
  const [text, setText] = useState('');

  // ğŸŸ¡ A different function whenever `text` changes
  const onClick = useCallback(() => {
    sendMessage(text);
  }, [text]);

  return <SendButton onClick={onClick} />;
}
```

### é€šè¿‡Â useCallback[3]Â è¿”å›ä¸€ä¸ª memoized å›è°ƒå‡½æ•°ã€‚

> useCallbackï¼šè¿”å›ä¸€ä¸ªÂ memoized[4]Â å›è°ƒå‡½æ•°ã€‚æŠŠå†…è”å›è°ƒå‡½æ•°åŠä¾èµ–é¡¹æ•°ç»„ä½œä¸ºå‚æ•°ä¼ å…¥Â `useCallback`ï¼Œå®ƒå°†è¿”å›è¯¥å›è°ƒå‡½æ•°çš„Â `memoized`Â ç‰ˆæœ¬ï¼Œè¯¥å›è°ƒå‡½æ•°ä»…åœ¨æŸä¸ªä¾èµ–é¡¹æ”¹å˜æ—¶æ‰ä¼šæ›´æ–°ã€‚å½“ä½ æŠŠå›è°ƒå‡½æ•°ä¼ é€’ç»™ç»è¿‡ä¼˜åŒ–çš„å¹¶ä½¿ç”¨å¼•ç”¨ç›¸ç­‰æ€§å»é¿å…éå¿…è¦æ¸²æŸ“ï¼ˆä¾‹å¦‚Â `shouldComponentUpdate`ï¼‰çš„å­ç»„ä»¶æ—¶ï¼Œå®ƒå°†éå¸¸æœ‰ç”¨ã€‚Â `useCallback(fn, deps)`Â ç›¸å½“äºÂ `useMemo(() => fn, deps)`ã€‚

**æœ€ç»ˆä½¿å¾—`onClick`çš„å¼•ç”¨å§‹ç»ˆä¸å˜**
**ä½†æ˜¯ï¼**`onClcik`è¿™ä¸ªæ–¹æ³•æœ‰éœ€è¦ä¿è¯æ¯æ¬¡éƒ½è¦æ‹¿åˆ°æœ€æ–°çš„ã€æ­£ç¡®çš„textï¼Œæ‰€ä»¥ä»–çš„`deps`ä¸­å°±è‡ªç„¶æ˜¯è®¾ç½®äº†`text`â€”â€” åäº†ï¼Œâ€œåˆå›åˆ°æœ€åˆçš„èµ·ç‚¹~â€ã€‚éšç€æ¯ä¸€æ¬¡`keystroke`ï¼Œ`onClick`åˆå˜æˆäº†ä¸Šé¢çš„æƒ…å†µï¼š

> ğŸŸ¡ Always a different function

ä½†ä½ åˆä¸èƒ½å°†å…¶ä»`deps`ä¸­ç§»é™¤ï¼Œç§»é™¤äº†ä»–å°±åªèƒ½æ‹¿åˆ°`text`çš„åˆå§‹å€¼ï¼Œå¤±å»äº†ä»–æœ¬è¯¥æœ‰çš„åŠŸèƒ½...

## å° useEvent æ¥ç»™ä»–æ•´ä¸ªæ´»ğŸ˜

`useEvent`å°±æ˜¯ä¸ºäº†è§£å†³æ­¤ç±»é—®é¢˜ï¼Œæ‰€ä»¥ä»–å¹²è„†ä¸è¦`deps`äº†ï¼Œä»–å°±æ˜¯ä¸€ç›´è¿”å›ä¸€ä¸ªç›¸åŒçš„å‡½æ•°å¼•ç”¨ï¼Œå“ªæ€•`text`å‘ç”Ÿå˜åŒ–ã€‚**å½“ç„¶ï¼Œä¿è¯å®ƒä¹Ÿèƒ½æ‹¿åˆ°æœ€æ–°çš„ã€æ­£ç¡®çš„**`**text**`**ã€‚**

```
function Chat() {
  const [text, setText] = useState('');

  // âœ… Always the same function (even if `text` changes)
  const onClick = useEvent(() => {
    sendMessage(text);
  });

  return <SendButton onClick={onClick} />;
}
```

ç°åœ¨å¥½äº†ï¼š

*   onClick çš„å¼•ç”¨å§‹ç»ˆæ˜¯åŒä¸€ä¸ª
*   ä¿è¯æ¯æ¬¡éƒ½èƒ½æ‹¿åˆ°æœ€æ–°çš„ã€æ­£ç¡®çš„Â `text`

* * *

å½“ç„¶è¿˜æœ‰å…¶ä»–ä¸€äº›åœºæ™¯ï¼Œä½†æ˜¯å¤§è‡´éœ€æ±‚åŸç†ç›¸åŒï¼Œå°±æ˜¯ä¸æƒ³è®©`A`å› ä¸º`b`å˜åŒ–è€Œæ€»æ˜¯é‡æ–°åŠ è½½ï¼Œä½†æ˜¯åˆå› ä¸ºè¦æ‹¿åˆ°`b`æ°å½“çš„å€¼ï¼Œæ‰€ä»¥`deps`ä¸­å¿…é¡»`b`ï¼Œå¯¼è‡´ä¸å¾—ä¸é‡æ–°åŠ è½½ï¼Œæ‰è¿›äº†â€œåœˆåœˆåœ†åœ†åœˆåœˆ~â€çš„é™·é˜±ã€‚æ›´å¤šåœºæ™¯è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚æ›´å¤šæ¡ˆä¾‹å¯æŸ¥çœ‹æ–‡æœ«çš„å­¦ä¹ èµ„æº~

## å¥½æ´»å¥½æ´»ğŸ”

æ€»è€Œè¨€ä¹‹ï¼Œç”¨`useEvent`ç»™ä»–è£¹ä¸Šå°±æ˜¯é¦™ï¼Œå°±æ˜¯å¯ä»¥åŒæ—¶è¾¾åˆ°ä¸Šé¢ä¸¤ä¸ªæ•ˆæœï¼š

*   å¼•ç”¨ä¸å˜
*   æ‹¿åˆ°æ°å½“çš„å€¼

# è¿™æ˜¯å’‹åšåˆ°çš„ğŸŒ

è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»–è¿™æ˜¯å’‹åšåˆ°çš„
ä»–**å¤§æ¦‚**æ˜¯è¿™ä¹ˆä¸ªå½¢çŠ¶ï¼šï¼ˆä¸æ˜¯æºç å°±é•¿è¿™æ ·çš„æ„æ€å—·ï¼‰

```
// (!) Approximate behavior

function useEvent(handler) {
  const handlerRef = useRef(null);

  // In a real implementation, this would run before layout effects
  useLayoutEffect(() => {
    handlerRef.current = handler;
  });

  return useCallback((...args) => {
    // In a real implementation, this would throw if called during render
    const fn = handlerRef.current;
    return fn(...args);
  }, []);
}
```

## å…ˆå›é¡¾å‡ ä¸ªHookç›¸å…³çŸ¥è¯†ç‚¹ï¼š

### useRef

useRef[5]:

> useRef è¿”å›ä¸€ä¸ªå¯å˜çš„ ref å¯¹è±¡ï¼Œå…¶ .current å±æ€§è¢«åˆå§‹åŒ–ä¸ºä¼ å…¥çš„å‚æ•°ï¼ˆinitialValueï¼‰ã€‚è¿”å›çš„ ref å¯¹è±¡åœ¨ç»„ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…æŒç»­å­˜åœ¨ã€‚

è¿™é‡Œé€šè¿‡ useRef ä¿å­˜å›è°ƒå‡½æ•°`handler`åˆ°`handlerRef.current`ï¼Œç„¶åå†åœ¨ useCallback ä¸­ä»`handlerRef.current`æ¥å–å‡½æ•°å†è°ƒç”¨ï¼Œè¿™æ ·é¿å…äº†ç›´æ¥è°ƒç”¨ï¼Œè·³å‡ºäº†é—­åŒ…é™·é˜±ã€‚å¹¶ä¸”ä¸å‡ºæ„å¤–çš„è¯`handler`åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…æŒç»­å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯**åªæœ‰ä¸€ä¸ªå¼•ç”¨**ã€‚

### useLayoutEffect

è¿™ä¸ªÂ useLayoutEffect[6]Â å¯èƒ½æ²¡é‚£ä¹ˆå¸¸ç”¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ˜¯å•¥å˜

> å…¶å‡½æ•°ç­¾åä¸ useEffect ç›¸åŒï¼Œä½†å®ƒä¼šåœ¨æ‰€æœ‰çš„ DOM å˜æ›´ä¹‹ååŒæ­¥è°ƒç”¨ effectã€‚å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯»å– DOM å¸ƒå±€å¹¶åŒæ­¥è§¦å‘é‡æ¸²æŸ“ã€‚åœ¨æµè§ˆå™¨æ‰§è¡Œç»˜åˆ¶ä¹‹å‰ï¼ŒuseLayoutEffect å†…éƒ¨çš„æ›´æ–°è®¡åˆ’å°†è¢«åŒæ­¥åˆ·æ–°ã€‚

### useEffect

å›é¡¾ä¸€ä¸‹Â useEffect[7]

> é»˜è®¤æƒ…å†µä¸‹ï¼Œeffect å°†åœ¨æ¯è½®æ¸²æŸ“ç»“æŸåæ‰§è¡Œ

### ä¸¤è€…çš„åŒºåˆ«

å¥½äº†ï¼Œç°åœ¨æˆ‘ç»™ä½ ç”¨ä¸€ä¸ªå­—æ€»ç»“ä¸€ä¸‹ä¸¤è€…åŒºåˆ«ï¼Œ`useLayoutEffect`Â æ›´â€œå¿«â€ï¼è¿™ä¸ªâ€œå—â€ä¸æ˜¯é€Ÿåº¦æ›´å¿«ï¼Œè€Œæ˜¯ä»–â€œæŠ¢è·‘â€äº†å“©ã€‚`useLayoutEffect`Â æ˜¯åœ¨`render`ä¹‹å‰åŒæ­¥æ‰§è¡Œï¼Œ`useEffect`åœ¨`render`ä¹‹åå¼‚æ­¥æ‰§è¡Œï¼Œè¿™é‡Œå°±æ˜¯ä¿è¯`useLayoutEffect`Â é‡Œçš„å›è°ƒè‚¯å®šæ¯”`useEffect`æ›´æ—©å‰è¢«è°ƒç”¨ã€è¢«æ‰§è¡Œã€‚

### useCallback

#### æ‰§è¡Œæ—¶æœº

å‰é¢è¯´åˆ°

> `useCallback(fn, deps)`Â ç›¸å½“äºÂ `useMemo(() => fn, deps)`ã€‚

æ–‡æ¡£é‡Œæ˜¯è¿™æ ·è¯´Â useMemo[8]Â çš„ï¼š

> è®°ä½ï¼Œ**ä¼ å…¥ useMemo çš„å‡½æ•°ä¼šåœ¨æ¸²æŸ“æœŸé—´æ‰§è¡Œ**ã€‚è¯·ä¸è¦åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨æ‰§è¡Œä¸æ¸²æŸ“æ— å…³çš„æ“ä½œï¼Œè¯¸å¦‚å‰¯ä½œç”¨è¿™ç±»çš„æ“ä½œå±äº useEffect çš„é€‚ç”¨èŒƒç•´ï¼Œè€Œä¸æ˜¯ useMemoã€‚

ä¹Ÿå°±æ˜¯ä»–æ˜¯åœ¨`render`**æ—¶**æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯ä¿è¯äº†èµ‹å€¼`handler`ç»™`handlerRef.current`æ˜¯åœ¨å‰é¢å‘ç”Ÿ

#### è¿™é‡Œçš„ä½œç”¨

è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ª`useCallback`åŒ…è£¹åÂ `memoized`å‡½æ•°ï¼Œå…¶ä¸­ä»`handlerRef.current`ä¸­è·å–å‡½æ•°ï¼Œå¹¶ä¸”`deps`ä¸º`[]`ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä¸ä¼šå†æ¬¡æ›´æ–°ã€‚

* * *

# æ‹ä¸€æ‹ğŸŒŠ

å›é¡¾å®ŒçŸ¥è¯†ç‚¹æˆ‘ä»¬ä¹Ÿå°±æ»¤æ¸…äº†è¿™ä¸ª`useEvent`æ–¹æ³•ï¼Œä¸€å¥è¯æ€»ç»“å°±æ˜¯ï¼šå®ƒæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°`handler`ä½œä¸ºå‚æ•°ï¼Œ**æä¾›ç»™ä½ ä¸€ä¸ªç¨³å®šçš„å‡½æ•°ï¼ˆå§‹ç»ˆåªæœ‰ä¸€ä¸ªå¼•ç”¨ï¼‰**å¹¶ä¸”è°ƒç”¨æ—¶éƒ½æ˜¯ç”¨çš„ä½ ä¼ å…¥çš„**æœ€æ–°çš„å‚æ•°**`...args`â€”â€”æ¯”å¦‚å‰é¢æ¡ˆä¾‹ä¸­çš„`text`ï¼Œå§‹ç»ˆéƒ½æ˜¯**æœ€æ–°çš„ã€æ­£ç¡®çš„ã€æ°å½“çš„ã€‚**
å†ç»“åˆä¸€å¼€å§‹çš„æ¡ˆä¾‹ï¼Œå¤§æ¦‚æµç¨‹å°±æ˜¯è¿™æ ·ï¼š


![](https://upload-images.jianshu.io/upload_images/10024246-2f48097fe3ff505f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä¸è¿‡ç›®å‰è¿™ä¸ªä¹Ÿæ˜¯ 5.4å·åˆšåˆšæå‡ºï¼Œä¹Ÿå°±æ˜¯æ˜¨å¤©ï¼Œåœ¨æ­£å¼ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨åº”è¯¥è¿˜æ—©ï¼Œä½†æˆ‘å¸Œæœ›ä½ è¿˜æ˜¯èƒ½ä»æœ¬æ–‡æœ‰æ‰€æ”¶è·æ»´~

> ğŸŒŠå¦‚æœæœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµå…³æ³¨ï¼Œä¸€èµ·è¿›æ­¥â›µ
å…³äºæœ¬æ–‡ æ¥è‡ªï¼šå‰èˆŸ
https://juejin.cn/post/7094186419500875812
